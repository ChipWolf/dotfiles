#!/bin/bash

# -e: exit on error
# -u: exit on unset variables
set -eu
{{ if .codespaces -}}
set -x
{{- end }}

# Brewfile hash (triggers re-run when Brewfile changes):
# {{ include "Brewfile" | sha256sum }}

{{ if .codespaces -}}
cat <<EOF >"$HOME/.gitconfig.overrides"
[user]
	name = Chip Wolf â€®
[gpg]
	program = /.codespaces/bin/gh-gpgsign
EOF
{{ end -}}

{{ if eq .chezmoi.os "linux" -}}
PKGS="build-essential procps curl file git"
if ! dpkg -s $PKGS &>/dev/null; then
  sudo apt update -q
  sudo apt install -yq $PKGS
fi
{{ end -}}

{{- if eq .chezmoi.os "darwin" "linux" -}}
if ! command -v brew 2>&1 >/dev/null; then
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

if ! command -v brew 2>&1 >/dev/null; then
  export PATH="$PATH:$HOME/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/bin:/opt/homebrew/bin"
  eval $(brew shellenv)
fi

NVIM_PRE_INSTALLED=""
if command -v nvim 2>&1 >/dev/null; then
  NVIM_PRE_INSTALLED=1
fi

# do not enforce sha
unset HOMEBREW_CASK_OPTS
export HOMEBREW_NO_AUTO_UPDATE=1

{{- if not .codespaces }}
brew update
brew doctor || true
{{- end }}

{{- if .codespaces }}
CODESPACES=1 brew bundle -q --file="$CHEZMOI_SOURCE_DIR/Brewfile" || true
{{- else }}
brew bundle -q --file="$CHEZMOI_SOURCE_DIR/Brewfile"
{{- end }}

{{- if not .codespaces }}
brew upgrade --cask --greedy
brew upgrade --greedy
brew outdated --cask --greedy --verbose
brew outdated --greedy --verbose
brew cleanup
{{- end }}

# Prewarm antidote plugin cache so the first shell launch doesn't clone everything
zsh -c '
  zstyle ":antidote:bundle" use-friendly-names yes
  source "$(brew --prefix)/opt/antidote/share/antidote/antidote.zsh"
  antidote bundle < "${ZDOTDIR:-$HOME/.config/zsh}/.zplugins" > /dev/null
' || true

{{- if not .codespaces }}
mise trust
mise install

if [ -z "$NVIM_PRE_INSTALLED" ]; then
  nvim --headless "+Lazy! sync" +qa
fi
{{- end }}

# Reload all running zsh sessions so they pick up the updated config
{{- if .codespaces }}
pkill -HUP -u "$USER" zsh || true
{{- end }}
{{ end -}}
